"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),Object.defineProperty(a,"prototype",{writable:!1}),a}var vertexSphereShader="\nuniform float uTime;\nvarying vec2 vUv;\nfloat PI = 3.14159265359;\n\nvoid main(){\n  vec3 pos = position;\n  \n  pos.y += sin(pos.y * 0.01 - uTime * 20.0) * 20.0;\n  pos.z += sin(pos.y * 0.01 - uTime * 20.0) * 20.0;\n  \n  vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n  \n  vUv = uv;\n  \n  gl_Position = projectionMatrix * mvPosition;\n}\n\n",fragmentSphereShader="\nuniform float uTime;\nuniform sampler2D uTexture;\nvarying vec2 vUv;\n\nvoid main () {\n  vec4 color = texture2D(uTexture, vUv);\n  \n  gl_FragColor = vec4(1.0 - color);\n}\n",vertexGroundShader="\nuniform float uTime;\nvarying vec2 vUv;\nfloat PI = 3.14159265359;\n\nvoid main(){\n  vec3 newPosition = position;\n\n  newPosition.y = sin(newPosition.x / PI * 2.0 + uTime) * 10.0 + newPosition.y;\n  newPosition.z = sin(newPosition.y / PI * 2.0 + uTime) * 5.0 + newPosition.z;\n  newPosition.x = sin(newPosition.z / PI * 2.0 + uTime) * 5.0 + newPosition.x;\n  \n  vec4 mvPosition = modelViewMatrix * vec4(newPosition, 1.0);\n  \n  vUv = uv;\n  \n  gl_Position = projectionMatrix * mvPosition;\n}\n",vertexRainShader="\nattribute float number;\nuniform float uTime;\nuniform vec2 uResolution;\nfloat PI = 3.14159265359;\n\nvoid main(){\n  vec3 pos = position;\n  \n  pos.x += tan(pos.x + uTime * 10.0 * number) * 100.0;\n  pos.y -= tan(pos.y + uTime * 10.0 * 0.5) * 100.0;\n  pos.z -= tan(pos.z + uTime * 10.0 * number) * 100.0;\n  \n  vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n  \n  gl_PointSize = 40.0 * (80.0 / - mvPosition.z);\n  gl_Position = projectionMatrix * mvPosition;\n}\n",fragmentRainShader="\nvarying vec3 vPosition;\n\nvoid main () {\n  float f = length(gl_PointCoord - vec2(0.5, 0.5));\n  if ( f > 0.1 ) discard;\n  \n  gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n",Mouse=function(){function a(b){_classCallCheck(this,a),this.sketch=b,this.initialize()}return _createClass(a,[{key:"initialize",value:function initialize(){this.delta=0,this.mouse=new THREE.Vector3,this.setupEvents()}},{key:"setupEvents",value:function setupEvents(){window.addEventListener("scroll",this.onScroll.bind(this),!1),window.addEventListener("mousemove",this.onMousemove.bind(this),!1),window.addEventListener("touchmove",this.onTouchmove.bind(this),!1)}},{key:"onScroll",value:function onScroll(){var a=window.pageYOffset,b=document.body.scrollHeight-window.innerHeight;this.delta=a/b}},{key:"onMousemove",value:function onMousemove(a){this.mouse.x=2*(a.clientX/window.innerWidth)-1,this.mouse.y=2*-(a.clientY/window.innerHeight)+1,this.mouse.z=0}},{key:"onTouchmove",value:function onTouchmove(a){var b=a.targetTouches[0];this.mouse.x=2*(b.pageX/window.innerWidth)-1,this.mouse.y=2*-(b.pageY/window.innerHeight)+1,this.mouse.z=0}}]),a}(),Sketch=function(){function a(){_classCallCheck(this,a),this.createCanvas(),this.setupEvents(),this.time=new THREE.Clock(!0),this.mouse=new Mouse(this),this.initialize()}return _createClass(a,[{key:"createCanvas",value:function createCanvas(){this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),document.body.appendChild(this.renderer.domElement)}},{key:"setupEvents",value:function setupEvents(){window.addEventListener("resize",this.onResize.bind(this),!1)}},{key:"onResize",value:function onResize(){this.preWidth===window.innerWidth&&480>window.innerWidth||this.initialize()}},{key:"initialize",value:function initialize(){this.animationId&&cancelAnimationFrame(this.animationId),this.preWidth=this.width=Math.ceil(window.innerWidth),this.height=Math.ceil(window.innerHeight),this.scene=new THREE.Scene,this.setupCanvas(),this.setupCamera(),this.setupShape(),this.draw()}},{key:"setupCanvas",value:function setupCanvas(){this.renderer.setSize(this.width,this.height),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setClearColor("#EDECE8",1),this.renderer.domElement.style.position="fixed",this.renderer.domElement.style.top="0",this.renderer.domElement.style.left="0",this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.renderer.domElement.style.zIndex="-1",this.renderer.domElement.style.outline="none"}},{key:"setupCamera",value:function setupCamera(){var a=35*(Math.PI/180);this.dist=this.height/2/Math.tan(a),this.camera=new THREE.PerspectiveCamera(70,this.width/this.height,.01,10*this.dist),this.cameraV=new THREE.Vector3,this.cameraP=new THREE.Vector3(0,0,this.dist),this.camera.position.set(this.cameraP),this.camera.lookAt(new THREE.Vector3),this.scene.add(this.camera)}},{key:"updateCamera",value:function updateCamera(){this.cameraV.subVectors(this.mouse.mouse,this.cameraP).multiplyScalar(.05),this.cameraP.add(this.cameraV),this.camera.position.set(this.cameraP.x*this.dist,Math.max(150*this.cameraP.y,-150),this.dist),this.camera.lookAt(new THREE.Vector3)}},{key:"setupLight",value:function setupLight(){this.directionalLight=new THREE.DirectionalLight(16777215),this.scene.add(this.directionalLight),this.spotLight=new THREE.SpotLight(16777215),this.spotLight.position.set(this.dist,this.dist,this.dist),this.scene.add(this.spotLight)}},{key:"setupShape",value:function setupShape(){this.setupSize(),this.shape=new Shape(this,0,0,0,this.sphereSize,this.rainNumber,this.groundSize)}},{key:"setupSize",value:function setupSize(){this.sphereSize=null,this.groundSize=Math.max(this.width,this.height),this.rainNumber=null,768>=this.width&&(this.sphereSize=120,this.rainNumber=5e3),768<=this.width&&(this.sphereSize=192,this.rainNumber=2e4)}},{key:"draw",value:function draw(){var a=this.time.getElapsedTime();this.shape.render(.1*a),this.updateCamera(a),this.renderer.render(this.scene,this.camera),this.animationId=requestAnimationFrame(this.draw.bind(this))}}]),a}(),Shape=function(){function a(b,c,d,e,f,h,i){_classCallCheck(this,a),this.sketch=b,this.sphereSize=f,this.rainNumber=h,this.groundSize=i,this.position=new THREE.Vector3(c,d,e),this.initialize()}return _createClass(a,[{key:"initialize",value:function initialize(){this.createTexture(),this.sphereGeometry=new THREE.SphereGeometry(this.sphereSize,32,32),this.sphereMaterial=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:{uTime:{type:"f",value:0},uTexture:{type:"t",value:this.returnTexture()}},vertexShader:vertexSphereShader,fragmentShader:fragmentSphereShader}),this.sphereMesh=new THREE.Mesh(this.sphereGeometry,this.sphereMaterial),this.sphereMesh.position.set(this.position.x,this.position.y,this.position.z),this.sketch.scene.add(this.sphereMesh),this.rainGeometry=new THREE.BufferGeometry,this.vertices=new Float32Array(3*this.rainNumber),this.numbers=new Float32Array(this.rainNumber);for(var a=0;a<3*this.rainNumber;a++)this.vertices[3*a+0]=Math.random()*this.sketch.width-this.sketch.width/2,this.vertices[3*a+1]=Math.random()*this.sketch.height-this.sketch.height/2,this.vertices[3*a+2]=Math.random()*this.sketch.dist-this.sketch.dist/2;for(var b=0;b<this.rainNumber;b++)this.numbers[b]=Math.random();this.rainGeometry.setAttribute("position",new THREE.BufferAttribute(this.vertices,3)),this.rainGeometry.setAttribute("number",new THREE.BufferAttribute(this.numbers,1)),this.rainMaterial=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:{uTime:{type:"f",value:0}},vertexShader:vertexRainShader,fragmentShader:fragmentRainShader}),this.rain=new THREE.Points(this.rainGeometry,this.rainMaterial),this.sketch.scene.add(this.rain),this.groundGeometry=new THREE.PlaneGeometry(this.groundSize,this.groundSize,32,32),this.groundMaterial=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:{uTime:{type:"f",value:0},uTexture:{type:"t",value:this.returnTexture()}},vertexShader:vertexGroundShader,fragmentShader:fragmentSphereShader}),this.groundMesh=new THREE.Mesh(this.groundGeometry,this.groundMaterial),this.groundMesh.rotation.x=-90*Math.PI/180,this.groundMesh.position.y=-this.sphereSize,this.sketch.scene.add(this.groundMesh)}},{key:"createTexture",value:function createTexture(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d");this.canvas.width=256,this.canvas.height=256,this.pdm=new CellAutomaton(this.ctx,256,256),this.texture=new THREE.CanvasTexture(this.canvas)}},{key:"returnTexture",value:function returnTexture(){return this.texture}},{key:"updateTexture",value:function updateTexture(){this.pdm.render()}},{key:"render",value:function render(a){this.texture.needsUpdate=!0,this.updateTexture(a),this.rain.material.uniforms.uTime.value=a,this.groundMesh.material.uniforms.uTime.value=a,this.sphereMesh.material.uniforms.uTime.value=a}}]),a}(),CellAutomaton=function(){function a(b,c,d){_classCallCheck(this,a),this.ctx=b,this.width=c,this.height=d,this.state=this.createMultipleArray(this.height,this.width),this.lastState=this.createMultipleArray(this.height,this.width),this.d=this.ctx.createImageData(this.width,this.height),this.setupData()}return _createClass(a,[{key:"createMultipleArray",value:function createMultipleArray(a,b){for(var c=[],d=0;d<a;d++){c[d]=[];for(var e=0;e<b;e++)c[d][e]=0}return c}},{key:"setupData",value:function setupData(){for(var a=0;a<this.height;a++)for(var b=0;b<this.width;b++)this.state[a][b]=Math.floor(256*Math.random())}},{key:"drawData",value:function drawData(){this.ctx.putImageData(this.d,0,0)}},{key:"updateData",value:function updateData(){for(var a=0;a<this.height;a++)for(var b,c=0;c<this.width;c++)b=a*this.width+c,this.d.data[4*b+0]=255,this.d.data[4*b+1]=255,this.d.data[4*b+2]=255,this.d.data[4*b+3]=255-this.state[a][c]}},{key:"updateState",value:function updateState(){for(var a=this.createMultipleArray(this.height,this.width),c=0;c<this.height;c++)for(var r=0;r<this.width;r++){var d=0,e=c-1,f=c+1,g=r-1,h=r+1;0>e&&(e=this.height-1),f==this.height&&(f=0),0>g&&(g=this.width-1),h==this.width&&(h=0);var i=this.state[e][r],j=this.state[c][h],k=this.state[f][r],b=this.state[c][g],l=this.state[e][g],m=this.state[f][g],n=this.state[f][h],o=this.state[e][h];d=i+j+k+b+l+m+n+o;var p=Math.floor(d/8),q=void 0;255==p?q=0:0==p?q=255:(q=this.state[c][r]+p,0<this.lastState[c][r]&&(q-=this.lastState[c][r]),255<q?q=255:0>q&&(q=0)),a[c][r]=q}this.lastState=this.state,this.state=a}},{key:"render",value:function render(){this.ctx.clearRect(0,0,this.width,this.height),this.updateData(),this.updateState(),this.drawData()}}]),a}();(function(){window.addEventListener("load",function(){new Loading("loading","loaded"),new FullScreen,new Sketch})})();